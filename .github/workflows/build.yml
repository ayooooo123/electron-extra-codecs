# =============================================================================
# Builds linux-arm64 on a self-hosted ARM Linux runner.
# x64 and win32 builds require an x64-capable runner/emulation layer and are
# intentionally excluded from this workflow.
#
# macOS builds run on Cirrus CI (see .cirrus.yml) and upload to the same
# GitHub Release via the gh CLI.
#
# Self-hosted runner requirements:
#   Label: "electron-builder"
#   OS:    Fedora 39+ / Ubuntu 22.04+ (arm64)
#   Disk:  200+ GB SSD
#   RAM:   32+ GB
#   Deps:  build-essential, python3, git, curl + Chromium build deps
# =============================================================================

name: Build Electron Extra Codecs

on:
  workflow_dispatch:
    inputs:
      electron_version:
        description: Electron git tag to build
        required: true
        default: v40.4.1
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  ELECTRON_VERSION: ${{ github.event.inputs.electron_version || 'v40.4.1' }}

jobs:
  validate:
    name: Validate patch scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Python syntax
        run: python3 -c "import ast; ast.parse(open('scripts/patch_chromium_media.py').read())"

      - name: Check Bash syntax
        run: |
          bash -n scripts/patch_ffmpeg.sh
          bash -n scripts/apply_all.sh

      - name: Check YAML syntax
        run: python3 -c "import yaml; yaml.safe_load(open('.github/workflows/build.yml'))"

      - name: Check inline Python in patch_ffmpeg.sh
        run: |
          python3 -c "
          text = open('scripts/patch_ffmpeg.sh').read()
          start = text.index(\"<<'PY'\") + len(\"<<'PY'\")
          end = text.index('\nPY\n', start)
          import ast; ast.parse(text[start:end])
          "

  build:
    name: Build ${{ matrix.name }}
    needs: validate
    runs-on: electron-builder
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        include:
          - name: linux-arm64
            target_os: linux
            target_cpu: arm64
            artifact: electron-linux-arm64.zip

    steps:
      - name: Checkout patch repo
        uses: actions/checkout@v4
        with:
          path: electron-extra-codecs

      - name: Report disk space
        run: df -h .

      - name: Install build deps
        run: |
          if command -v dnf >/dev/null 2>&1; then
            sudo dnf install -y gcc gcc-c++ make python3 python3-pip git curl \
              ca-certificates pkgconf gtk3-devel libnotify-devel nss-devel \
              libXScrnSaver alsa-lib-devel cups-devel libXtst-devel \
              atk-devel at-spi2-atk-devel libdrm-devel mesa-libgbm-devel \
              dbus-devel libxkbcommon-devel pango-devel \
              gperf bison flex perl clang lld
          elif command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y build-essential python3 python3-pip git curl \
              lsb-release ca-certificates pkg-config libgtk-3-dev libnotify-dev \
              libnss3-dev libxss1 libasound2-dev libcups2-dev \
              libxtst-dev libatk1.0-dev libatk-bridge2.0-dev libdrm-dev \
              libgbm-dev
          else
            echo "Unsupported package manager" && exit 1
          fi

      - name: Setup depot_tools
        run: |
          if [[ ! -d "$HOME/depot_tools" ]]; then
            git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git "$HOME/depot_tools"
          else
            # gclient sync leaves depot_tools in detached HEAD â€” fetch+reset handles that
            git -C "$HOME/depot_tools" fetch origin
            git -C "$HOME/depot_tools" checkout -f main 2>/dev/null || git -C "$HOME/depot_tools" checkout -f master
            git -C "$HOME/depot_tools" reset --hard origin/main 2>/dev/null || git -C "$HOME/depot_tools" reset --hard origin/master
          fi
          echo "$HOME/depot_tools" >> "$GITHUB_PATH"

      - name: Clean previous checkout state
        run: |
          if [[ -d src ]]; then
            find src -name "*.lock" -path "*/.git/*" -delete 2>/dev/null || true
            git -C src rebase --abort 2>/dev/null || true
            git -C src am --abort 2>/dev/null || true
            git -C src merge --abort 2>/dev/null || true
            git -C src checkout -- . 2>/dev/null || true
            git -C src clean -fd 2>/dev/null || true
          fi

      - name: Sync Electron source
        timeout-minutes: 180
        run: |
          mkdir -p "$HOME/.gclient-cache"
          export GIT_CACHE_PATH="$HOME/.gclient-cache"
          if [[ ! -f .gclient ]]; then
            gclient config --name "src/electron" --unmanaged https://github.com/electron/electron
          fi
          gclient sync --with_tags --revision "src/electron@$ELECTRON_VERSION" --reset --verbose --no-history

      - name: Apply codec patches
        working-directory: src
        run: |
          rm -rf electron-extra-codecs
          cp -R ../electron-extra-codecs electron-extra-codecs
          bash electron-extra-codecs/scripts/apply_all.sh

      - name: Install Linux sysroots
        if: matrix.target_os == 'linux'
        working-directory: src
        run: |
          python3 build/linux/sysroot_scripts/install-sysroot.py --arch=amd64
          python3 build/linux/sysroot_scripts/install-sysroot.py --arch=arm64

      - name: Build Electron
        working-directory: src
        run: |
          export CHROMIUM_BUILDTOOLS_PATH="$PWD/buildtools"
          gn_args='import("//electron/build/args/release.gn") target_cpu="${{ matrix.target_cpu }}"'
          if [[ "${{ matrix.target_os }}" == "win" ]]; then
            gn_args+=' target_os="win"'
          fi
          gn gen out/Release --args="$gn_args"
          ninja -C out/Release electron
          python3 electron/script/strip-binaries.py -d out/Release || true
          ninja -C out/Release electron:electron_dist_zip

      - name: Rename dist artifact
        run: cp src/out/Release/dist.zip "${{ matrix.artifact }}"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}
          if-no-files-found: error

      - name: Clean build output
        if: always()
        run: rm -rf src/out/Release

  release:
    name: Create release
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect release files
        run: |
          mkdir -p release
          find artifacts -name '*.zip' -exec cp {} release/ \;
          ls -lh release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Electron Extra Codecs ${{ github.ref_name }}"
          body: |
            Custom Electron build based on **${{ env.ELECTRON_VERSION }}** with extra codec support:
            - HEVC (H.265) software decode
            - AC3 (Dolby Digital) software decode
            - EAC3 (Dolby Digital Plus) software decode
            - DTS software decode

            ## Downloads

            Built on self-hosted ARM64 Linux runner.
            macOS builds are added separately via Cirrus CI (see `.cirrus.yml`).

            | Platform | File |
            |----------|------|
            | Linux arm64 | `electron-linux-arm64.zip` |

            These are full Electron `dist.zip` archives.
          files: release/*
          fail_on_unmatched_files: false
