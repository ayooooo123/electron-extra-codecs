# =============================================================================
#
# macOS builds run on Cirrus CI (see .cirrus.yml) and upload to the same
# GitHub Release via the gh CLI.
#
# Self-hosted runner requirements:
#   Label: "electron-builder"
#   OS:    Fedora 39+ / Ubuntu 22.04+ (arm64)
#   Disk:  200+ GB SSD
#   RAM:   32+ GB
#   Deps:  build-essential, python3, git, curl + Chromium build deps
# =============================================================================

name: Build Electron Extra Codecs

on:
  workflow_dispatch:
    inputs:
      electron_version:
        description: Electron git tag to build
        required: true
        default: v40.4.1
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  ELECTRON_VERSION: ${{ github.event.inputs.electron_version || 'v40.4.1' }}

jobs:
  validate:
    name: Validate patch scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Python syntax
        run: |
          python3 -c "import ast; ast.parse(open('scripts/patch_chromium_media.py').read())"
          python3 -c "import ast; ast.parse(open('scripts/patch_ffmpeg_configs.py').read())"

      - name: Check Bash syntax
        run: |
          bash -n scripts/patch_ffmpeg.sh
          bash -n scripts/apply_all.sh

      - name: Check YAML syntax
        run: python3 -c "import yaml; yaml.safe_load(open('.github/workflows/build.yml'))"

      - name: Check inline Python in patch_ffmpeg.sh
        run: |
          python3 -c "
          text = open('scripts/patch_ffmpeg.sh').read()
          start = text.index(\"<<'PY'\") + len(\"<<'PY'\")
          end = text.index('\nPY\n', start)
          import ast; ast.parse(text[start:end])
          "

  build_linux:
    name: Build ${{ matrix.name }}
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        include:
          - name: linux-arm64
            target_os: linux
            target_cpu: arm64
            artifact: electron-linux-arm64.zip
          - name: linux-x64
            target_os: linux
            target_cpu: x64
            artifact: electron-linux-x64.zip

    steps:
      - name: Checkout patch repo
        uses: actions/checkout@v4
        with:
          path: electron-extra-codecs

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc \
            /usr/local/share/powershell /usr/share/swift /usr/local/.ghcup \
            /usr/lib/jvm /opt/hostedtoolcache/CodeQL || true
          sudo docker image prune --all --force 2>/dev/null || true
          sudo apt-get autoremove -y 2>/dev/null || true
          sudo apt-get clean 2>/dev/null || true
          df -h .

      - name: Install build deps
        run: |
          if command -v dnf >/dev/null 2>&1; then
            sudo dnf install -y gcc gcc-c++ make python3 python3-pip git curl \
              ca-certificates pkgconf gtk3-devel libnotify-devel nss-devel \
              libXScrnSaver alsa-lib-devel cups-devel libXtst-devel \
              atk-devel at-spi2-atk-devel libdrm-devel mesa-libgbm-devel \
              dbus-devel libxkbcommon-devel pango-devel \
              gperf bison flex perl clang lld
          elif command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y build-essential python3 python3-pip git curl \
              lsb-release ca-certificates pkg-config libgtk-3-dev libnotify-dev \
              libnss3-dev libxss1 libasound2-dev libcups2-dev \
              libxtst-dev libatk1.0-dev libatk-bridge2.0-dev libdrm-dev \
              libgbm-dev gperf
          else
            echo "Unsupported package manager" && exit 1
          fi

      - name: Setup depot_tools
        run: |
          if [[ ! -d "$HOME/depot_tools" ]]; then
            git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git "$HOME/depot_tools"
          else
            # gclient sync leaves depot_tools in detached HEAD â€” fetch+reset handles that
            git -C "$HOME/depot_tools" fetch origin
            git -C "$HOME/depot_tools" checkout -f main 2>/dev/null || git -C "$HOME/depot_tools" checkout -f master
            git -C "$HOME/depot_tools" reset --hard origin/main 2>/dev/null || git -C "$HOME/depot_tools" reset --hard origin/master
          fi
          echo "$HOME/depot_tools" >> "$GITHUB_PATH"

      - name: Clean previous checkout state
        run: |
          if [[ -d src ]]; then
            find src -name "*.lock" -path "*/.git/*" -delete 2>/dev/null || true
            git -C src rebase --abort 2>/dev/null || true
            git -C src am --abort 2>/dev/null || true
            git -C src merge --abort 2>/dev/null || true
            git -C src checkout -- . 2>/dev/null || true
            git -C src clean -fd 2>/dev/null || true
          fi

      - name: Sync Electron source
        timeout-minutes: 180
        run: |
          mkdir -p "$HOME/.gclient-cache"
          export GIT_CACHE_PATH="$HOME/.gclient-cache"
          if [[ ! -f .gclient ]]; then
            gclient config --name "src/electron" --unmanaged https://github.com/electron/electron
          fi
          gclient sync --with_tags --revision "src/electron@$ELECTRON_VERSION" --reset --verbose --no-history

      - name: Ensure packed refs file exists
        working-directory: src/electron
        run: |
          git pack-refs --all || true
          test -f .git/packed-refs || touch .git/packed-refs

      - name: Apply codec patches
        working-directory: src
        run: |
          rm -rf electron-extra-codecs
          cp -R ../electron-extra-codecs electron-extra-codecs
          bash electron-extra-codecs/scripts/apply_all.sh

      - name: Install Linux sysroots
        if: matrix.target_os == 'linux'
        working-directory: src
        run: |
          python3 build/linux/sysroot_scripts/install-sysroot.py --arch=amd64
          python3 build/linux/sysroot_scripts/install-sysroot.py --arch=arm64

      - name: Build Electron
        working-directory: src
        run: |
          export CHROMIUM_BUILDTOOLS_PATH="$PWD/buildtools"
          gn_args='import("//electron/build/args/release.gn") target_cpu="${{ matrix.target_cpu }}" enable_platform_hevc=true enable_hevc_parser_and_hw_decoder=true enable_platform_ac3_eac3_audio=true enable_platform_dts_audio=true symbol_level=0 blink_symbol_level=0 enable_nacl=false'
          gn gen out/Release --args="$gn_args"
          ninja -C out/Release -j$(nproc) electron
          python3 electron/script/strip-binaries.py -d out/Release || true
          ninja -C out/Release -j$(nproc) electron:electron_dist_zip

      - name: Rename dist artifact
        run: cp src/out/Release/dist.zip "${{ matrix.artifact }}"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}
          if-no-files-found: error

      - name: Clean build output
        if: always()
        run: rm -rf src/out/Release

  build_windows:
    name: Build win32-x64
    needs: validate
    runs-on: windows-latest
    timeout-minutes: 360
    env:
      DEPOT_TOOLS_WIN_TOOLCHAIN: "0"
    steps:
      - name: Checkout patch repo
        uses: actions/checkout@v4
        with:
          path: electron-extra-codecs

      - name: Setup depot_tools
        shell: pwsh
        run: |
          $depotTools = "$env:USERPROFILE\depot_tools"
          if (!(Test-Path $depotTools)) {
            git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git $depotTools
          } else {
            git -C $depotTools fetch origin
            try { git -C $depotTools checkout -f main } catch { git -C $depotTools checkout -f master }
            try { git -C $depotTools reset --hard origin/main } catch { git -C $depotTools reset --hard origin/master }
          }
          Add-Content -Path $env:GITHUB_PATH -Value $depotTools

      - name: Sync Electron source
        shell: pwsh
        timeout-minutes: 180
        run: |
          if (!(Test-Path .gclient)) {
            gclient config --name "src/electron" --unmanaged https://github.com/electron/electron
          }
          gclient sync --with_tags --revision "src/electron@$env:ELECTRON_VERSION" --reset --verbose --no-history

      - name: Ensure packed refs file exists
        shell: pwsh
        working-directory: src/electron
        run: |
          git pack-refs --all
          if (!(Test-Path .git/packed-refs)) { New-Item -Path .git/packed-refs -ItemType File | Out-Null }

      - name: Apply codec patches
        shell: bash
        working-directory: src
        run: |
          rm -rf electron-extra-codecs
          cp -R ../electron-extra-codecs electron-extra-codecs
          bash electron-extra-codecs/scripts/apply_all.sh

      - name: Build Electron
        shell: pwsh
        working-directory: src
        run: |
          $env:CHROMIUM_BUILDTOOLS_PATH = "$PWD/buildtools"
          New-Item -ItemType Directory -Force out/Release | Out-Null
          @'
          import("//electron/build/args/release.gn")
          target_cpu = "x64"
          target_os = "win"
          enable_platform_hevc = true
          enable_hevc_parser_and_hw_decoder = true
          enable_platform_ac3_eac3_audio = true
          enable_platform_dts_audio = true
          symbol_level = 0
          blink_symbol_level = 0
          enable_nacl = false
          '@ | Set-Content out/Release/args.gn
          gn gen out/Release
          $numCores = (Get-CimInstance Win32_Processor).NumberOfLogicalProcessors
          ninja -C out/Release "-j$numCores" electron
          python3 electron/script/strip-binaries.py -d out/Release 2>$null; $true
          ninja -C out/Release "-j$numCores" electron:electron_dist_zip

      - name: Rename dist artifact
        shell: pwsh
        run: Copy-Item src/out/Release/dist.zip electron-win32-x64.zip

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: electron-win32-x64.zip
          path: electron-win32-x64.zip
          if-no-files-found: error

      - name: Clean build output
        if: always()
        shell: pwsh
        run: Remove-Item -Recurse -Force src/out/Release -ErrorAction SilentlyContinue

  release:
    name: Create release
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build_linux, build_windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect release files
        run: |
          mkdir -p release
          find artifacts -name '*.zip' -exec cp {} release/ \;
          ls -lh release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Electron Extra Codecs ${{ github.ref_name }}"
          body: |
            Custom Electron build based on **${{ env.ELECTRON_VERSION }}** with extra codec support:
            - HEVC (H.265) software decode
            - AC3 (Dolby Digital) software decode
            - EAC3 (Dolby Digital Plus) software decode
            - DTS software decode

            ## Downloads (Linux + Windows)

            Built on GitHub-hosted x64 Linux runners.
            macOS builds are added separately via Cirrus CI (see `.cirrus.yml`).

            | Platform | File |
            |----------|------|
            | Linux arm64 | `electron-linux-arm64.zip` |
            | Linux x64 | `electron-linux-x64.zip` |
            | Windows x64 | `electron-win32-x64.zip` |

            These are full Electron `dist.zip` archives.
          files: release/*
          fail_on_unmatched_files: false
